name: Update Packagers
on:
  release:
    types: [published]
permissions:
  contents: write
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
      - name: Update Homebrew Formula and Scoop manifest to this tag
        shell: bash
        env:
          TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          echo "Updating packaging files to tag $TAG"
          # Update Homebrew Formula
          if [ -f Formula/writetofillet.rb ]; then
            sed -i.bak -E "s/^\s*version\s+[:\"a-zA-Z0-9_.-]+/  version \"$TAG\"/" Formula/writetofillet.rb || true
            sed -i.bak -E "s|/releases/(latest|download/[^/]+)/download/|/releases/download/$TAG/|g" Formula/writetofillet.rb || true
            sed -i.bak -E "s|/releases/latest/download/|/releases/download/$TAG/|g" Formula/writetofillet.rb || true
            rm -f Formula/writetofillet.rb.bak
          fi
          # Update Scoop manifest
          if [ -f bucket/writetofillet.json ]; then
            sed -i.bak -E "s/\"version\"\s*:\s*\"[^\"]*\"/\"version\": \"$TAG\"/" bucket/writetofillet.json || true
            sed -i.bak -E "s|/releases/(latest|download/[^/]+)/download/|/releases/download/$TAG/|g" bucket/writetofillet.json || true
            sed -i.bak -E "s|/releases/latest/download/|/releases/download/$TAG/|g" bucket/writetofillet.json || true
            rm -f bucket/writetofillet.json.bak
          fi
          # Commit and push if changed
          if git status --porcelain | grep .; then
            git config user.name github-actions
            git config user.email github-actions@github.com
            git add Formula/writetofillet.rb bucket/writetofillet.json || true
            git commit -m "chore(packaging): update Homebrew/Scoop to $TAG"
            git push
          else
            echo "No packaging changes needed."
          fi

